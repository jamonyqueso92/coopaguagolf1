<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Oficina Virtual</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        body { background-color: #f8f9fa; }
        .card { transition: transform 0.2s; border: none; box-shadow: 0 2px 4px rgba(0,0,0,0.1);}
        .card:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15);}
        .icon-large { font-size: 3rem;}
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: flex; justify-content: center; align-items: center; z-index: 9999;}
        .navbar-brand { font-weight: 600;}
        .alert-warning { border-left: 4px solid #ffc107;}
        .alert-success { border-left: 4px solid #28a745;}
        .table th { background-color: #f8f9fa; font-weight: 600;}
        .disabled-section { opacity: 0.5; pointer-events: none;}
        .perfil-incompleto { border: 2px solid #ffc107; background-color: #fff3cd;}
        .form-floating label { font-weight: 500;}
        .btn-pulse { animation: pulse 2s infinite;}
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    </style>
</head>
<body>
    <!-- Loading overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="text-center">
            <div class="spinner-border text-primary mb-3" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <p>Verificando autenticación...</p>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#" onclick="irAInicio()">
                <i class="bi bi-droplet-fill me-2"></i>
                Cooperativa Agua Golf
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="#" id="navDashboard">
                            <i class="bi bi-house-fill me-1"></i>Inicio
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="navFacturas">
                            <i class="bi bi-receipt me-1"></i>Facturas
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="navReclamos">
                            <i class="bi bi-exclamation-triangle me-1"></i>Reclamos
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="navPerfil">
                            <i class="bi bi-person-circle me-1"></i>Mi Perfil
                        </a>
                    </li>
                </ul>
                <div class="d-flex align-items-center">
                    <span class="navbar-text me-3">
                        <i class="bi bi-person-fill me-1"></i>
                        <span id="userDisplayName">Cargando...</span>
                    </span>
                    <button id="btnLogout" class="btn btn-outline-light btn-sm">
                        <i class="bi bi-box-arrow-right me-1"></i>Cerrar Sesión
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Sección Facturas -->
    <div id="facturas" class="seccion-dashboard" style="display: none;">
        <div class="container my-4">
            <h2 class="text-primary mb-4">
                <i class="bi bi-receipt me-2"></i>Mis Facturas
            </h2>
            <div id="tablaFacturas"></div>
            <h3 class="mt-5 text-danger"><i class="bi bi-exclamation-triangle me-2"></i>Comprobantes Impagos</h3>
            <div id="tablaImpagos"></div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-light text-center py-4 mt-5">
        <div class="container">
            <p class="mb-0 text-muted">&copy; 2025 Cooperativa Agua Golf</p>
        </div>
    </footer>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>

    <script>
        // Configuración de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyA3EwtirsHI_kwxMLH5SP2rXbm3vCYpqhg",
            authDomain: "coopaguagolf-b1e2f.firebaseapp.com",
            projectId: "coopaguagolf-b1e2f",
            storageBucket: "coopaguagolf-b1e2f.appspot.com",
            messagingSenderId: "980063915524",
            appId: "1:980063915524:web:e991b552b607d2447aef51",
            measurementId: "G-V6Z34N9V06"
        };
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();

        let currentUser = null;
        let userProfile = null;

        document.addEventListener('DOMContentLoaded', function() {
            verificarAutenticacion();
        });

        function verificarAutenticacion() {
            auth.onAuthStateChanged(function(user) {
                const loadingOverlay = document.getElementById('loadingOverlay');
                if (user) {
                    currentUser = user;
                    cargarPerfilUsuario(user.uid);
                    document.getElementById('userDisplayName').textContent = user.email || "Usuario";
                    mostrarSeccion('facturas');
                    loadingOverlay.style.display = 'none';
                } else {
                    document.body.innerHTML = `
                        <div class="container-fluid d-flex justify-content-center align-items-center min-vh-100 bg-light">
                            <div class="text-center">
                                <div class="alert alert-warning p-4">
                                    <i class="bi bi-exclamation-triangle display-4 text-warning mb-3"></i>
                                    <h3>Acceso Restringido</h3>
                                    <p class="mb-3">Necesitas iniciar sesión para acceder al dashboard.</p>
                                    <a href="index.html" class="btn btn-primary">
                                        <i class="bi bi-arrow-left me-1"></i>Volver al Inicio
                                    </a>
                                </div>
                            </div>
                        </div>
                    `;
                }
            });
        }

        function cargarPerfilUsuario(userId) {
            db.collection('usuarios').doc(userId).get()
                .then((doc) => {
                    if (doc.exists) {
                        userProfile = doc.data();
                        cargarMisFacturas(userProfile.numeroSuministro);
                        cargarMisImpagos(userProfile.numeroSuministro);
                    } else {
                        alert("No se encontró el perfil del usuario.");
                    }
                })
                .catch((error) => {
                    alert('Error al cargar datos del perfil');
                });
        }

        function mostrarSeccion(seccionId) {
            document.querySelectorAll('.seccion-dashboard').forEach(sec => sec.style.display = 'none');
            const seccion = document.getElementById(seccionId);
            if (seccion) seccion.style.display = 'block';
        }

        document.getElementById('navDashboard').addEventListener('click', () => mostrarSeccion('dashboard'));
        document.getElementById('navFacturas').addEventListener('click', () => mostrarSeccion('facturas'));
        document.getElementById('navPerfil').addEventListener('click', () => mostrarSeccion('perfil'));
        document.getElementById('navReclamos').addEventListener('click', () => mostrarSeccion('reclamos'));
        document.getElementById('btnLogout').addEventListener('click', function() {
            auth.signOut().then(() => {
                window.location.href = "index.html";
            }).catch(() => {
                alert('No se pudo cerrar sesión. Intente nuevamente.');
            });
        });
        window.irAInicio = function() { mostrarSeccion('dashboard'); };

        // === Leer datos de Google Sheets ===

        // Utilidad para convertir CSV a array de objetos
        function parseCSV(text, delimiter = ';') {
            const lines = text.trim().split('\n');
            const headers = lines[0].split(delimiter).map(h => h.trim());
            return lines.slice(1).map(line => {
                const values = line.split(delimiter).map(v => v.trim());
                return headers.reduce((obj, h, i) => { obj[h] = values[i] || ''; return obj; }, {});
            });
        }

        // Leer facturas de Google Sheets
        function cargarMisFacturas(numeroSuministro) {
            // Link CSV export de la hoja de facturación (Hoja 03-2025)
            // OJO: Si la hoja cambia de nombre, actualiza el &sheet=03-2025
            const SHEET_FACTURAS_URL = "https://docs.google.com/spreadsheets/d/11aj5qSGy06wOCPkKFXUPdi4akoLWYNlgCFjZYJ3D-2Y/gviz/tq?tqx=out:csv&sheet=03-2025";
            fetch(SHEET_FACTURAS_URL)
                .then(res => res.text())
                .then(csvText => {
                    const facturas = parseCSV(csvText);
                    // Filtrar por número de suministro
                    const mias = facturas.filter(f => f['Usuario'] && f['Usuario'].trim() === numeroSuministro);
                    let html = `<table class="table"><thead>
                        <tr><th>Periodo</th><th>Vencimiento</th><th>Importe</th><th>PDF</th></tr>
                    </thead><tbody>`;
                    mias.forEach(f => {
                        // El nombre de archivo está en la columna "archivo"
                        // Si tienes el fileID en esa columna (por ejemplo: 1vRr...xyz), arma el link así:
                        // let pdfLink = `https://drive.google.com/file/d/${f['archivo']}/view?usp=sharing`;

                        // Si solo tienes el nombre (ej: 20250709-96-0003-00037689-00001.pdf), arma el link así:
                        // let pdfLink = `https://drive.google.com/drive/u/3/folders/1NKtdt1GlPYQwe-XKYdqPp3jF9dSloPWA`; // solo la carpeta
                        // Pero para el link directo, lo mejor es tener el fileID en la hoja

                        // Si tienes el nombre, busca el PDF manualmente en la carpeta compartida para cada usuario, o puedes mostrar el nombre para que lo busque.
                        let pdfLink = f['archivo'] ? `https://drive.google.com/drive/u/3/folders/1NKtdt1GlPYQwe-XKYdqPp3jF9dSloPWA` : '#';
                        html += `<tr>
                            <td>${f.Periodo}</td>
                            <td>${f.Vencimiento}</td>
                            <td>$${parseFloat(f.Importe).toLocaleString("es-AR")}</td>
                            <td>${f['archivo'] ? `<span>${f['archivo']}</span>` : 'No disponible'}</td>
                        </tr>`;
                    });
                    html += `</tbody></table>`;
                    document.getElementById('tablaFacturas').innerHTML = html;
                })
                .catch(() => {
                    document.getElementById('tablaFacturas').innerHTML = '<div class="alert alert-danger">No se pudieron cargar las facturas.</div>';
                });
        }

        // Leer comprobantes impagos de Google Sheets
        function cargarMisImpagos(numeroSuministro) {
            // Link CSV export de la hoja de impagos (Hoja 03-2025)
            const SHEET_IMPAGOS_URL = "https://docs.google.com/spreadsheets/d/1m7GnmOaARUHDZbn5gGPCUV3mfqElYPl0WcnZsQj6l8I/gviz/tq?tqx=out:csv&sheet=03-2025";
            fetch(SHEET_IMPAGOS_URL)
                .then(res => res.text())
                .then(csvText => {
                    const impagos = parseCSV(csvText);
                    // Filtrar por número de suministro
                    const mios = impagos.filter(f => f['Usuario'] && f['Usuario'].trim() === numeroSuministro);
                    let html = `<table class="table"><thead>
                        <tr><th>Fecha Emisión</th><th>Comprobante</th><th>Importe</th></tr>
                    </thead><tbody>`;
                    mios.forEach(f => {
                        html += `<tr>
                            <td>${f['Fecha emision']}</td>
                            <td>${f.Comprobante}</td>
                            <td>$${parseFloat(f.Importe).toLocaleString("es-AR")}</td>
                        </tr>`;
                    });
                    html += `</tbody></table>`;
                    document.getElementById('tablaImpagos').innerHTML = html;
                })
                .catch(() => {
                    document.getElementById('tablaImpagos').innerHTML = '<div class="alert alert-danger">No se pudieron cargar los comprobantes impagos.</div>';
                });
        }
    </script>
</body>
</html>
